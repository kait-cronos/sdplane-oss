# L2リピーターアプリケーション

**言語 / Language:** [English](../l2-repeater-application.md) | **日本語**

L2リピーターアプリケーションは、MACアドレス学習と更新機能を備えた、DPDKポート間でのシンプルなレイヤー2パケット転送を提供します。

## 概要

L2リピーターは、以下の機能を持つ直感的なレイヤー2転送アプリケーションです：
- 宛先MACアドレスに基づくDPDKポート間でのパケット転送
- 転送テーブル構築のためのMACアドレス学習
- MACアドレス更新機能（送信元MACアドレスの変更）
- DPDKのゼロコピーパケット処理による高性能動作

## 主要機能

### レイヤー2転送
- **宛先ベース転送**: 宛先MACアドレスに基づくパケットルーティング
- **MAC学習**: MACアドレスの自動学習と転送テーブル構築
- **ブロードキャスト処理**: ブロードキャストおよび未知のユニキャストトラフィックの適切な処理
- **ポートペアリング**: シンプルなポート対ポート転送設定のサポート

### パフォーマンス特性
- **ゼロコピー処理**: DPDKの効率的なパケット処理の使用
- **バースト処理**: 最適なスループットのためのパケットのバースト処理
- **低遅延**: 高速転送のための最小限の処理オーバーヘッド
- **マルチコアサポート**: スケーリング用の専用lcore上での実行

## 設定

### 基本セットアップ
L2リピーターは、メインのsdplane設定システムを通じて設定されます：

```bash
# ワーカータイプをL2リピーターに設定
set worker lcore 1 l2-repeater

# ポートとキューの設定
set thread 1 port 0 queue 0  
set thread 1 port 1 queue 0

# 学習のためにプロミスキャスモードを有効化
set port all promiscuous enable
```

### 設定ファイル例
完全な設定例については、[`example-config/sdplane_l2_repeater.conf`](../../example-config/sdplane_l2_repeater.conf)をご覧ください：

```bash
# デバイスバインディング
set device 02:00.0 driver vfio-pci bind
set device 03:00.0 driver vfio-pci bind

# DPDK初期化
set rte_eal argv -c 0x7
rte_eal_init
set mempool

# ポート設定
stop port all
set port all dev-configure 1 4
set port all nrxdesc 1024
set port all ntxdesc 1024

# ワーカーセットアップ
set worker lcore 1 l2-repeater
set worker lcore 2 tap-handler
set port all promiscuous enable
start port all

# ワーカー開始
start worker lcore all
```

## 動作

### MACアドレス学習
L2リピーターは受信パケットからMACアドレスを自動学習します：
- **送信元学習**: 送信元MACアドレスと入力ポートの記録
- **転送テーブル**: 既知の宛先の転送テーブルの維持
- **エージング**: 学習エントリのエージング処理（実装依存）

### 転送動作
- **既知のユニキャスト**: 学習したポートへの宛先MAC転送
- **未知のユニキャスト**: 入力ポート以外のすべてのポートへのフラッド
- **ブロードキャスト/マルチキャスト**: 入力ポート以外のすべてのポートへのフラッド
- **ループ防止**: 基本的なスプリットホライゾン転送（ヘアピニングなし）

### MACアドレス更新
有効にすると、L2リピーターはパケットのMACアドレスを変更できます：
- **送信元MAC更新**: 送信元MACを出力ポートのMACに変更
- **透過ブリッジング**: 元のMACアドレスの維持（デフォルト）

## パフォーマンス調整

### バッファ設定
```bash
# ワークロードに合わせてディスクリプタ数を最適化
set port all nrxdesc 2048  # 高パケットレート用に増加
set port all ntxdesc 2048  # バッファリング用に増加
```

### ワーカー割り当て
```bash
# L2転送用に特定のlcoreを専用化
set worker lcore 1 l2-repeater  # 専用コアに割り当て
set worker lcore 2 tap-handler  # TAP処理を分離
```

### メモリプールサイジング
メモリプールは予想されるトラフィックに適切にサイズ設定する必要があります：
- パケットレートとバッファ要件を考慮
- バーストサイズと一時的なパケットストレージを考慮

## 監視とデバッグ

### ポート統計
```bash
# 転送統計の表示
show port statistics all

# 特定のポートの監視
show port statistics 0
show port statistics 1
```

### デバッグコマンド
```bash
# L2転送デバッグの有効化
debug l2fwd enable

# 転送テーブルの表示（利用可能な場合）
show l2fwd table
```

## 使用ケース

### シンプルブリッジ
- 2つのネットワークセグメントの接続
- 透過レイヤー2転送
- 学習ブリッジ機能

### ポートミラーリング/リピーティング
- ポート間でのトラフィックミラーリング
- ネットワーク監視と解析
- シンプルなパケット複製

### パフォーマンステスト
- 転送パフォーマンスの測定
- L2転送ベンチマークのベースライン
- DPDKポート設定の検証

## 制限事項

- **VLAN処理なし**: VLAN認識なしのシンプルなL2転送
- **制限された転送テーブル**: 固定またはサイズ制限のある転送テーブル
- **STPサポートなし**: スパニングツリープロトコルの実装なし
- **基本的なフラッド制御**: 限定的なブロードキャストストーム保護

## 関連アプリケーション

- **拡張リピーター**: VLANサポートとTAPインターフェースを備えた高度版
- **L3転送**: レイヤー3ルーティング機能
- **VLANスイッチ**: VLAN対応スイッチング機能

VLANサポートを含むより高度なレイヤー2機能については、[拡張リピーター](enhanced-repeater.md)のドキュメントをご覧ください。